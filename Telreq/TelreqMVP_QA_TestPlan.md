# Telreq MVP 包括的QAテストプラン

## 概要
TelreqアプリのMVP機能に対する包括的なQAテストプランです。権限拒否状態、Azure接続失敗、メモリ管理問題などの現在の問題環境を考慮したテストシナリオを含みます。

## MVP機能一覧
1. 録音開始 → 録音停止
2. "テキスト書き起こし中..." 表示
3. AI要約とTODO抽出
4. ポップアップ表示
5. 履歴自動保存

## 現在の問題環境
- 音声認識権限: 拒否状態
- Azure接続: 失敗（デフォルト値使用）
- AudioCaptureService: メモリ管理問題（qualityMonitorTimerの循環参照）

---

## テストシナリオ

### 1. 権限拒否状態でのMVP動作テスト

#### 1.1 マイクロフォン権限拒否時の動作
**環境**: マイクロフォン権限が拒否されている状態

**テストケース**: TC-PERM-001
**目的**: マイクロフォン権限拒否時の適切なエラーハンドリング検証
**手順**:
1. アプリを初回起動
2. マイクロフォン権限要求に対して「拒否」を選択
3. 録音開始ボタンをタップ
4. エラーメッセージとリカバリーオプションを確認

**期待結果**:
- 権限拒否エラーが適切に表示される
- 設定アプリへの誘導が表示される
- アプリがクラッシュしない
- UIが適切に無効化される

#### 1.2 音声認識権限拒否時の動作
**環境**: 音声認識権限が拒否されている状態

**テストケース**: TC-PERM-002
**目的**: 音声認識権限拒否時のフォールバック動作検証
**手順**:
1. マイクロフォン権限は許可、音声認識権限は拒否の状態
2. 録音開始→録音停止を実行
3. ダミーテキストによる代替処理を確認

**期待結果**:
- ダミーテキスト「これはテスト録音です...」が表示される
- AI要約とTODO抽出が正常に動作する
- ポップアップが表示される
- 履歴に保存される

#### 1.3 設定画面への誘導機能
**テストケース**: TC-PERM-003
**目的**: 権限設定誘導機能の検証
**手順**:
1. 権限拒否状態でアプリを起動
2. 権限要求アラートで「設定を開く」をタップ
3. 設定アプリでの権限変更後、アプリに戻る

**期待結果**:
- 設定アプリが正しく開く
- アプリに戻った際に権限状態が正しく反映される

### 2. Azure接続失敗時のフォールバック動作テスト

#### 2.1 Azure Speech Service接続失敗
**環境**: Azure Speech Serviceが利用できない状態

**テストケース**: TC-AZURE-001
**目的**: Azure音声認識失敗時のローカル処理フォールバック検証
**手順**:
1. ネットワークをオフラインに設定
2. 録音開始→録音停止を実行
3. ダミーテキストでの処理継続を確認

**期待結果**:
- SpeechRecognitionServiceが適切にfailしてdummyテキストに切り替わる
- 処理が継続される
- エラーログが適切に出力される

#### 2.2 Azure OpenAI Service接続失敗
**環境**: Azure OpenAI Serviceが利用できない状態

**テストケース**: TC-AZURE-002
**目的**: Azure AI要約失敗時のローカル要約生成検証
**手順**:
1. 音声認識は成功、AI要約サービスが失敗する状態
2. 録音→書き起こし→要約処理の流れを実行
3. ローカル要約生成の動作を確認

**期待結果**:
- `generateLocalSummary`メソッドが呼び出される
- 文字数に応じた要約が生成される
- 簡単なTODO抽出が動作する
- 結果がポップアップで表示される

#### 2.3 Azure Storage Service接続失敗
**環境**: Azure Storage Serviceが利用できない状態

**テストケース**: TC-AZURE-003
**目的**: Azure Storage失敗時のローカル保存検証
**手順**:
1. ネットワーク接続不良を想定
2. 録音完了後の保存処理を実行
3. ローカル保存の動作を確認

**期待結果**:
- `offlineDataManager.saveLocalData`が実行される
- データがローカルに正しく保存される
- 履歴画面でデータが確認できる

### 3. エラーハンドリング検証テスト

#### 3.1 音声キャプチャエラー
**テストケース**: TC-ERROR-001
**目的**: AudioCaptureServiceエラー時の動作検証
**手順**:
1. 録音中にオーディオセッション割り込みを発生させる（着信など）
2. エラー復旧動作を確認
3. UIの状態遷移を確認

**期待結果**:
- 割り込み処理が適切に動作する
- 録音状態が正しく更新される
- ユーザーに適切なフィードバックが提供される

#### 3.2 メモリ管理問題の検証
**テストケース**: TC-ERROR-002
**目的**: AudioCaptureServiceのメモリリーク検証
**手順**:
1. 録音開始→停止を連続で複数回実行
2. メモリ使用量の変化を監視
3. qualityMonitorTimerの適切な解放を確認

**期待結果**:
- メモリリークが発生しない
- Timerが適切に無効化される
- アプリのパフォーマンスが劣化しない

#### 3.3 長時間録音時の安定性
**テストケース**: TC-ERROR-003
**目的**: 長時間録音での安定性検証
**手順**:
1. 5分以上の録音を実行
2. メモリ使用量とCPU使用率を監視
3. 正常な停止と処理完了を確認

**期待結果**:
- メモリ使用量が安定している
- CPU使用率が適切な範囲内
- 録音停止が正常に動作する

### 4. ユーザビリティとUX観点での評価テスト

#### 4.1 UI状態遷移の自然性
**テストケース**: TC-UX-001
**目的**: UI状態遷移の適切性検証
**手順**:
1. 録音開始→録音中表示→処理中表示→結果表示の流れを確認
2. 各状態でのボタンの有効/無効状態を確認
3. アニメーションとフィードバックを評価

**期待結果**:
- 状態遷移が直感的で分かりやすい
- 処理中の待機時間が適切に表示される
- ユーザーが次のアクションを理解できる

#### 4.2 エラーメッセージの分かりやすさ
**テストケース**: TC-UX-002
**目的**: エラーメッセージの理解しやすさ検証
**手順**:
1. 各種エラー状況を発生させる
2. エラーメッセージの内容を評価
3. リカバリー手順の明確さを確認

**期待結果**:
- エラーメッセージが技術的でない日本語で表示される
- 解決方法が明確に示される
- ユーザーが次にすべきことが分かる

#### 4.3 結果表示の有用性
**テストケース**: TC-UX-003
**目的**: 要約とTODO表示の有用性検証
**手順**:
1. 様々な内容の録音を実行
2. 生成された要約の質を評価
3. TODO抽出の精度を確認

**期待結果**:
- 要約が録音内容を適切に反映している
- TODOが実用的で理解しやすい
- ポップアップの表示が適切

### 5. 履歴機能の検証テスト

#### 5.1 履歴自動保存
**テストケース**: TC-HIST-001
**目的**: 履歴自動保存機能の検証
**手順**:
1. 複数回の録音を実行
2. 履歴画面でデータの保存を確認
3. データの整合性を検証

**期待結果**:
- 全ての録音が履歴に保存される
- タイムスタンプが正確
- 要約とTODOが正しく表示される

#### 5.2 履歴データの永続化
**テストケース**: TC-HIST-002
**目的**: アプリ終了後のデータ保持検証
**手順**:
1. 録音を実行して履歴に保存
2. アプリを完全終了
3. アプリ再起動後の履歴データ確認

**期待結果**:
- アプリ再起動後もデータが保持される
- データの破損が発生しない

---

## 実機テストとシミュレーターテストの比較

### 実機テスト（推奨）
**対象機種**: iPhone 12以降、iOS 15.0以降
**テスト項目**:
- 実際のマイクロフォン音声入力
- 音声認識精度
- バッテリー消費
- メモリ使用量
- ネットワーク接続状況の変化
- 着信など外部割り込み

### シミュレーターテスト（補完用）
**制限事項**:
- マイクロフォン入力の制限
- 音声認識機能の制約
- パフォーマンス特性の違い

**テスト可能項目**:
- UI表示とレイアウト
- 状態遷移ロジック
- エラーハンドリング
- データ保存機能

---

## 優先度付きテスト実行計画

### 高優先度（Critical Path）
1. **TC-PERM-002**: 音声認識権限拒否時のフォールバック動作
2. **TC-AZURE-002**: Azure AI要約失敗時のローカル処理
3. **TC-ERROR-002**: メモリ管理問題の検証
4. **TC-UX-001**: UI状態遷移の自然性

### 中優先度（Important）
1. **TC-PERM-001**: マイクロフォン権限拒否時の動作
2. **TC-AZURE-001**: Azure音声認識接続失敗
3. **TC-ERROR-001**: 音声キャプチャエラー処理
4. **TC-HIST-001**: 履歴自動保存

### 低優先度（Nice to Have）
1. **TC-PERM-003**: 設定画面誘導機能
2. **TC-AZURE-003**: Azure Storage接続失敗
3. **TC-ERROR-003**: 長時間録音安定性
4. **TC-UX-002**: エラーメッセージの分かりやすさ
5. **TC-UX-003**: 結果表示の有用性
6. **TC-HIST-002**: 履歴データ永続化

---

## 特定された重要な問題

### 1. AudioCaptureServiceのメモリ管理問題
**場所**: `/Users/suguruhirayama/Telreq/Telreq/Telreq/Services/AudioCaptureService.swift`
**問題**: qualityMonitorTimerで潜在的な循環参照
**詳細**: 
- 371行目: `Timer.scheduledTimer`で`[weak self]`は使用されているが、timerの保持に問題がある可能性
- deinitでの適切な解放が必要

### 2. Azure設定の不完全性
**場所**: `/Users/suguruhirayama/Telreq/Telreq/Telreq/Config/AzureConfig.swift`
**問題**: デフォルト値が開発用ダミー値
**詳細**:
- 実用的でないプレースホルダー値が設定されている
- プロダクション環境での設定検証が厳格

### 3. 権限処理の複雑性
**場所**: `/Users/suguruhirayama/Telreq/Telreq/Telreq/ContentView.swift`
**問題**: 権限状態の複雑な組み合わせ処理
**詳細**:
- 188-224行目: 複雑な権限処理ロジック
- 複数の権限状態の組み合わせでの動作が不明確

---

## 推奨改善事項

### 即座に対応すべき項目
1. **AudioCaptureServiceのメモリリーク修正**
2. **権限拒否時のユーザー体験改善**
3. **Azure接続失敗のより明確なフィードバック**

### 中長期で対応すべき項目
1. **単体テストの追加**
2. **UI自動化テストの実装**
3. **パフォーマンス監視の強化**

---

## テスト環境要件

### 必須環境
- iOS 15.0以降の実機
- 開発者アカウント
- Xcode 14以降

### 推奨環境
- 複数の機種での検証（iPhone SE、iPhone 14 Pro等）
- 異なるネットワーク環境（Wi-Fi、4G/5G、オフライン）
- 異なる権限状態の事前設定

---

このQAテストプランに基づいて、現在の問題環境でのMVP機能の包括的な検証を実施することで、品質保証の観点から信頼性の高いアプリケーションの提供が可能になります。